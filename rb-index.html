<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Builder ‚Äî Build Track</title>
    <link rel="stylesheet" href="kodnest-premium.css">
</head>

<body>
    <div id="app" class="app-container">
        <!-- Content injected by JS -->
    </div>

    <script>
        // --- Configuration & State ---

        const steps = [
            { id: 1, route: '/rb/01-problem', title: 'Problem Definition', prompt: 'Define the core problem the AI Resume Builder solves. Focus on ATS rejection rates and generic formatting. Specifically, address how automated tracking systems discard up to 75% of resumes before human review, and how generic templates fail to highlight key skills relevant to specific job descriptions.' },
            { id: 2, route: '/rb/02-market', title: 'Market Research', prompt: 'Analyze the current market for resume builders. Identify key competitors like Resume.io, Teal, and NovoResume. Highlight their strengths (UI/UX, templates) and weaknesses (generic AI content, lack of specific ATS optimization). Identify the gap for a "Precision-Matched" AI Resume Builder.' },
            { id: 3, route: '/rb/03-architecture', title: 'Architecture', prompt: 'Outline the technical architecture for the MVP. Frontend: React + Tailwind CSS. Backend: Node.js + Express. AI Integration: OpenAI API (GPT-4 for generation). Database: MongoDB for user profiles and resume data. file storage: AWS S3 or similar for PDF storage. Authentication: Firebase or JWT.' },
            { id: 4, route: '/rb/04-hld', title: 'High-Level Design', prompt: 'Create the High-Level Design (HLD) diagram. Include: 1. User Interface (Input Form, Preview). 2. API Gateway. 3. Resume Parser Service (extracts text from existing PDFs). 4. AI Enhancement Engine (optimizes text based on job description). 5. PDF Generation Service (renders final document).' },
            { id: 5, route: '/rb/05-lld', title: 'Low-Level Design', prompt: 'Detail the Low-Level Design (LLD). Database Schemas: User { id, email, subscription }, Resume { id, userId, data: { personalInfo, experience[], education[], skills[] } }, JobDescription { id, text, keywords[] }. API Endpoints: POST /api/resumes/generate, POST /api/resumes/parse, GET /api/resumes/:id.' },
            { id: 6, route: '/rb/06-build', title: 'Build Phase', prompt: 'Initialize the project repository. Set up standard folder structure:\n/client (React app)\n  /src/components (ResumeForm, Preview, Dashboard)\n  /src/services (api.js)\n/server (Node app)\n  /routes (resumeRoutes.js)\n  /controllers (resumeController.js)\n  /models (Resume.js)\n\nInstall dependencies: react, axios, express, mongoose, openai.' },
            { id: 7, route: '/rb/07-test', title: 'Test Plan', prompt: 'Design a test plan. Unit Tests: Test ResumeParser with various PDF formats. Integration Tests: Verify AI generation produces valid JSON structure. End-to-End Tests: User flow from signup -> input resume -> input JD -> generate optimized resume -> download PDF.' },
            { id: 8, route: '/rb/08-ship', title: 'Ship Strategy', prompt: 'Define the deployment strategy. Frontend: Deploy to Vercel. Backend: Deploy to Railway or Render. Database: MongoDB Atlas. secure environment variables. Set up a CI/CD pipeline using GitHub Actions to run tests on push and deploy on merge to main.' }
        ];

        let currentRoute = window.location.hash.slice(1) || '/rb/01-problem';

        // --- Persistence Helpers ---

        function getArtifact(stepId) {
            return localStorage.getItem(`rb_step_${stepId}_artifact`) || '';
        }

        function saveArtifact(stepId, content) {
            localStorage.setItem(`rb_step_${stepId}_artifact`, content);
            render(); // Re-render to update UI state
        }

        function getStepStatus(stepId) {
            return JSON.parse(localStorage.getItem(`rb_step_${stepId}_status`)) || { worked: null, error: false };
        }

        function saveStepStatus(stepId, status) {
            localStorage.setItem(`rb_step_${stepId}_status`, JSON.stringify(status));
            render();
        }

        function getProofSubmission() {
            return JSON.parse(localStorage.getItem('rb_final_submission')) || { lovable: '', github: '', deploy: '' };
        }

        function saveProofSubmission(data) {
            localStorage.setItem('rb_final_submission', JSON.stringify(data));
        }

        // --- Checklist Helpers ---

        const CHECKLIST_ITEMS = [
            'All form sections save to localStorage',
            'Live preview updates in real-time',
            'Template switching preserves data',
            'Color theme persists after refresh',
            'ATS score calculates correctly',
            'Score updates live on edit',
            'Export buttons work (copy/download)',
            'Empty states handled gracefully',
            'Mobile responsive layout works',
            'No console errors on any page'
        ];

        function getChecklist() {
            return JSON.parse(localStorage.getItem('rb_checklist')) || {};
        }

        function toggleChecklistItem(idx) {
            const cl = getChecklist();
            cl[idx] = !cl[idx];
            localStorage.setItem('rb_checklist', JSON.stringify(cl));
            render();
        }

        function allChecklistPassed() {
            const cl = getChecklist();
            return CHECKLIST_ITEMS.every((_, i) => !!cl[i]);
        }

        // --- URL Validation ---

        function isValidUrl(str) {
            if (!str || !str.trim()) return false;
            try {
                const url = new URL(str.trim());
                return url.protocol === 'https:' || url.protocol === 'http:';
            } catch (_) {
                return false;
            }
        }

        // --- Logic & Gating ---

        function isStepComplete(stepId) {
            return !!getArtifact(stepId);
        }

        function canAccessStep(stepId) {
            if (stepId === 1) return true;
            return isStepComplete(stepId - 1);
        }

        function getCurrentStep() {
            return steps.find(s => s.route === currentRoute) || steps[0];
        }

        function getProjectStatus() {
            const submission = getProofSubmission();
            const allStepsDone = steps.every(s => isStepComplete(s.id));
            const allChecksDone = allChecklistPassed();
            const allLinksDone = isValidUrl(submission.lovable) && isValidUrl(submission.github) && isValidUrl(submission.deploy);
            if (allStepsDone && allChecksDone && allLinksDone) return 'Shipped';
            const completedCount = steps.filter(s => isStepComplete(s.id)).length;
            if (completedCount > 0) return 'In Progress';
            return 'Not Started';
        }

        // --- Navigation ---

        function navigate(route) {
            window.location.hash = route;
        }

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            // Basic route validation
            if (steps.some(s => s.route === hash) || hash === '/rb/proof') {
                currentRoute = hash;
            } else {
                currentRoute = '/rb/01-problem';
            }
            render();
        });

        // --- Actions ---

        function handleCopyArtifact(stepId) {
            const artifact = getArtifact(stepId);
            if (!artifact) return;
            navigator.clipboard.writeText(artifact).then(() => alert('Artifact copied to clipboard!'));
        }

        function handleCopyPrompt(text) {
            navigator.clipboard.writeText(text).then(() => alert('Prompt copied to clipboard!'));
        }

        function handleBuildStatus(stepId, worked) {
            const status = getStepStatus(stepId);
            status.worked = worked;
            status.error = !worked;
            saveStepStatus(stepId, status);
        }

        function handleProofInput(field, value) {
            const data = getProofSubmission();
            data[field] = value;
            saveProofSubmission(data);
            render(); // Update button state
        }

        function handleCopyFinalSubmission() {
            const data = getProofSubmission();
            const text = [
                '------------------------------------------',
                'AI Resume Builder ‚Äî Final Submission',
                '',
                `Lovable Project: ${data.lovable}`,
                `GitHub Repository: ${data.github}`,
                `Live Deployment: ${data.deploy}`,
                '',
                'Core Capabilities:',
                '- Structured resume builder',
                '- Deterministic ATS scoring',
                '- Template switching',
                '- PDF export with clean formatting',
                '- Persistence + validation checklist',
                '------------------------------------------'
            ].join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copy-submission-btn');
                if (btn) { btn.textContent = '‚úì Copied!'; setTimeout(() => { btn.textContent = 'Copy Final Submission'; }, 2000); }
            });
        }

        function handleArtifactInput(stepId, value) {
            // Save on input (auto-save behavior) or we could have a button. 
            // The prompt implies "Next disabled until artifact uploaded", so real-time or blur saving is good.
            // For simplicity, let's save on change/blur in the render, but we need a helper to just update storage without re-rendering everything immediately if focus is lost.
            // However, react-like re-rendering usually needs state. Here we use localStorage as state. 
            // We will attach onchange event.
            localStorage.setItem(`rb_step_${stepId}_artifact`, value);
            // We verify completion on render. To render the "Next" button enabled immediately, we might need to trigger render.
            // Let's use oninput to save and maybe debounce render or just let user click a "Save" button? 
            // The previous implementation had a "Mark as Complete" button. 
            // The prompt says "Store artifacts under rb_step_X_artifact".
            // Let's provide a textarea for the artifact and a save button/auto-save.
        }

        // --- Rendering ---

        function render() {
            const app = document.getElementById('app');
            const step = getCurrentStep();
            const isProofPage = currentRoute === '/rb/proof';

            // Check gating
            if (!isProofPage && !canAccessStep(step.id)) {
                // If trying to access a locked step, redirect to the last accessible one or show locked state.
                // Redirecting to the previous step is safer.
                // navigate(steps[step.id - 2].route); 
                // OR show a locked UI. Let's show locked UI for better UX.
            }

            const activeStepId = isProofPage ? 8 : step.id; // Just for status bar context

            let mainContent = '';
            let buildPanel = '';
            let footer = '';

            if (isProofPage) {
                // --- PROOF PAGE ---
                const submission = getProofSubmission();
                const cl = getChecklist();
                const allStepsDone = steps.every(s => isStepComplete(s.id));
                const allChecksDone = allChecklistPassed();
                const lovableValid = isValidUrl(submission.lovable);
                const githubValid = isValidUrl(submission.github);
                const deployValid = isValidUrl(submission.deploy);
                const allLinksValid = lovableValid && githubValid && deployValid;
                const isShipped = allStepsDone && allChecksDone && allLinksValid;
                const canCopy = allLinksValid;

                // A) Step Completion Overview
                const stepListHtml = steps.map(s => {
                    const done = isStepComplete(s.id);
                    return `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--c-border);border-radius:6px;background:var(--c-surface);">
                        <span style="font-size:13px;font-weight:500;">Step ${s.id}: ${s.title}</span>
                        <span class="badge ${done ? 'badge-success' : 'badge-status'}" style="font-size:11px;">${done ? '‚úì Done' : 'Pending'}</span>
                    </div>`;
                }).join('');

                // B) Checklist Items
                const checklistHtml = CHECKLIST_ITEMS.map((item, i) => {
                    const checked = !!cl[i];
                    return `
                    <label style="display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid ${checked ? 'var(--c-success-bg,#d1fae5)' : 'var(--c-border)'};border-radius:6px;background:${checked ? 'var(--c-success-bg,#f0fdf4)' : 'var(--c-surface)'};cursor:pointer;transition:all 0.15s;">
                        <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleChecklistItem(${i})" style="width:15px;height:15px;accent-color:var(--c-accent,#2563eb);cursor:pointer;">
                        <span style="font-size:13px;font-weight:${checked ? '500' : '400'};color:${checked ? 'var(--c-text)' : 'var(--c-text-muted,#6b7280)'};">${item}</span>
                        ${checked ? '<span style="margin-left:auto;font-size:11px;color:#16a34a;font-weight:600;">‚úì</span>' : ''}
                    </label>`;
                }).join('');

                // Shipped confirmation
                const shippedBanner = isShipped ? `
                    <div style="margin-bottom:24px;padding:20px 24px;border:1px solid #bbf7d0;border-radius:8px;background:#f0fdf4;">
                        <p style="margin:0;font-size:15px;font-weight:600;color:#15803d;letter-spacing:0.01em;">Project 3 Shipped Successfully.</p>
                    </div>` : '';

                mainContent = `
                    ${shippedBanner}
                    <div class="card">
                        <h2 style="margin-bottom:4px;">A ‚Äî Step Completion</h2>
                        <p style="margin-bottom:16px;">All 8 steps must be completed to ship.</p>
                        <div style="display:grid;gap:8px;">
                            ${stepListHtml}
                        </div>
                        <div style="margin-top:12px;padding:10px 14px;border-radius:6px;background:${allStepsDone ? 'var(--c-success-bg,#f0fdf4)' : 'var(--c-surface)'};border:1px solid ${allStepsDone ? '#bbf7d0' : 'var(--c-border)'};display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:13px;font-weight:600;">Steps Complete</span>
                            <span style="font-size:13px;font-weight:700;color:${allStepsDone ? '#16a34a' : 'var(--c-text-muted,#6b7280)'}">${steps.filter(s => isStepComplete(s.id)).length} / 8</span>
                        </div>
                    </div>

                    <div class="card" style="margin-top:16px;">
                        <h2 style="margin-bottom:4px;">B ‚Äî Test Checklist</h2>
                        <p style="margin-bottom:16px;">All 10 tests must pass to ship.</p>
                        <div style="display:grid;gap:8px;">
                            ${checklistHtml}
                        </div>
                        <div style="margin-top:12px;padding:10px 14px;border-radius:6px;background:${allChecksDone ? 'var(--c-success-bg,#f0fdf4)' : 'var(--c-surface)'};border:1px solid ${allChecksDone ? '#bbf7d0' : 'var(--c-border)'};display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:13px;font-weight:600;">Tests Passed</span>
                            <span style="font-size:13px;font-weight:700;color:${allChecksDone ? '#16a34a' : 'var(--c-text-muted,#6b7280)'}">${Object.values(cl).filter(Boolean).length} / 10</span>
                        </div>
                    </div>

                    <div class="card" style="margin-top:16px;">
                        <h2 style="margin-bottom:4px;">C ‚Äî Artifact Links</h2>
                        <p style="margin-bottom:16px;">All 3 links required. Must be valid URLs.</p>
                        <div style="display:flex;flex-direction:column;gap:14px;">
                            <div>
                                <label style="display:block;margin-bottom:5px;font-size:13px;font-weight:600;">Lovable Project Link</label>
                                <input type="url" class="input-field" value="${submission.lovable}" oninput="handleProofInput('lovable', this.value)" placeholder="https://lovable.dev/..." style="border-color:${lovableValid ? '#86efac' : submission.lovable ? '#fca5a5' : 'var(--c-border)'};">
                                ${submission.lovable && !lovableValid ? '<p style="margin:4px 0 0;font-size:11px;color:#dc2626;">Please enter a valid URL (https://...)</p>' : ''}
                                ${lovableValid ? '<p style="margin:4px 0 0;font-size:11px;color:#16a34a;">‚úì Valid URL</p>' : ''}
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-size:13px;font-weight:600;">GitHub Repository Link</label>
                                <input type="url" class="input-field" value="${submission.github}" oninput="handleProofInput('github', this.value)" placeholder="https://github.com/..." style="border-color:${githubValid ? '#86efac' : submission.github ? '#fca5a5' : 'var(--c-border)'};">
                                ${submission.github && !githubValid ? '<p style="margin:4px 0 0;font-size:11px;color:#dc2626;">Please enter a valid URL (https://...)</p>' : ''}
                                ${githubValid ? '<p style="margin:4px 0 0;font-size:11px;color:#16a34a;">‚úì Valid URL</p>' : ''}
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-size:13px;font-weight:600;">Deployed URL</label>
                                <input type="url" class="input-field" value="${submission.deploy}" oninput="handleProofInput('deploy', this.value)" placeholder="https://your-app.vercel.app" style="border-color:${deployValid ? '#86efac' : submission.deploy ? '#fca5a5' : 'var(--c-border)'};">
                                ${submission.deploy && !deployValid ? '<p style="margin:4px 0 0;font-size:11px;color:#dc2626;">Please enter a valid URL (https://...)</p>' : ''}
                                ${deployValid ? '<p style="margin:4px 0 0;font-size:11px;color:#16a34a;">‚úì Valid URL</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;

                const status = getProjectStatus();
                const statusBadgeClass = status === 'Shipped' ? 'badge-success' : status === 'In Progress' ? 'badge-progress' : 'badge-status';

                footer = `
                    <footer class="proof-footer">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-size:13px;font-weight:500;color:var(--c-text-muted,#6b7280);">Status:</span>
                            <span class="badge ${statusBadgeClass}">${status}</span>
                            ${!allStepsDone ? '<span style="font-size:11px;color:var(--c-text-muted,#6b7280);">Complete all 8 steps</span>' : !allChecksDone ? '<span style="font-size:11px;color:var(--c-text-muted,#6b7280);">Pass all 10 tests</span>' : !allLinksValid ? '<span style="font-size:11px;color:var(--c-text-muted,#6b7280);">Add 3 valid links</span>' : ''}
                        </div>
                        <button id="copy-submission-btn" class="btn btn-primary" onclick="handleCopyFinalSubmission()" ${!canCopy ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
                            Copy Final Submission
                        </button>
                    </footer>
                `;
            } else {
                // --- STEP PAGE ---

                // Locked Check
                if (!canAccessStep(step.id)) {
                    mainContent = `
                        <div class="card" style="text-align: center; padding: 64px;">
                            <h2>üîí Step Locked</h2>
                            <p>Please complete Step ${step.id - 1} first.</p>
                            <button class="btn btn-primary" onclick="navigate('${steps[step.id - 2].route}')" style="margin-top: 16px;">Go to Previous Step</button>
                        </div>
                     `;
                    // Hide build panel content if locked
                    buildPanel = `<div class="card" style="opacity: 0.5;"><p>Locked</p></div>`;
                } else {
                    const artifact = getArtifact(step.id);
                    const status = getStepStatus(step.id);

                    mainContent = `
                        <div class="card">
                            <h2>${step.title}</h2>
                            <p>${step.prompt}</p>
                            
                            <div style="margin-top: var(--s-3);">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Artifact</label>
                                <textarea class="input-field" style="min-height: 200px; font-family: monospace;" 
                                    placeholder="Paste your code, output, or notes here..."
                                    oninput="handleArtifactInput(${step.id}, this.value)"
                                    onblur="render()" 
                                >${artifact}</textarea>
                                <p class="subtext" style="margin-top: 8px;">Content performs auto-save on blur. Ensure content is present to unlock next step.</p>
                            </div>

                            <div style="margin-top: var(--s-3); display: flex; justify-content: space-between;">
                                <button class="btn btn-secondary" onclick="navigate('${step.id > 1 ? steps[step.id - 2].route : '#'}')" ${step.id === 1 ? 'disabled style="opacity:0.5; pointer-events:none;"' : ''}>Previous</button>
                                ${step.id < 8 ?
                            `<button class="btn btn-primary" onclick="navigate('${steps[step.id].route}')" ${!artifact ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>Next Step</button>`
                            :
                            `<button class="btn btn-primary" onclick="navigate('/rb/proof')" ${!artifact ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>Finish & Proof</button>`
                        }
                            </div>
                        </div>
                    `;

                    // Build Panel Logic
                    buildPanel = `
                        <div class="card" style="border: none; background: transparent; padding: 0;">
                            <h4>Build Actions</h4>
                        </div>

                        <div class="card">
                             <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 8px;">COPY THIS INTO LOVABLE</label>
                             <div class="prompt-box" style="max-height: 150px; overflow-y: auto;">${step.prompt}</div>
                             <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="handleCopyPrompt('${step.prompt.replace(/'/g, "\\'")}')">Copy Prompt</button>
                        </div>

                        <div class="card">
                            <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 8px;">BUILD IN LOVABLE</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button class="btn btn-primary" style="flex: 1; background: #2f855a; border-color: #2f855a; font-size: 12px;" onclick="handleBuildStatus(${step.id}, true)">It Worked</button>
                                <button class="btn btn-primary" style="flex: 1; background: #c53030; border-color: #c53030; font-size: 12px;" onclick="handleBuildStatus(${step.id}, false)">Error</button>
                            </div>
                            <button class="btn btn-secondary" style="width: 100%; font-size: 12px;" onclick="alert('Screenshot upload placeholder')">Add Screenshot</button>
                            
                            ${status.worked !== null ? `
                                <div style="margin-top: 12px; padding: 8px; background: ${status.worked ? 'var(--c-success-bg)' : 'var(--c-warning-bg)'}; border-radius: 4px; font-size: 12px; text-align: center;">
                                    ${status.worked ? '‚úÖ Marked as Working' : '‚ùå Marked as Error'}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }

            // Construct Full Layout
            app.innerHTML = `
                <!-- TOP BAR -->
                <header class="top-bar">
                    <div class="top-bar-left">
                        <span class="brand-name">AI Resume Builder</span>
                    </div>
                    <div class="top-bar-center">
                        <span class="subtext">${isProofPage ? 'Final Verification' : `Project 3 ‚Äî Step ${step.id} of 8`}</span>
                    </div>
                    <div class="top-bar-right">
                        <span class="badge ${getProjectStatus() === 'Shipped' ? 'badge-success' : getProjectStatus() === 'In Progress' ? 'badge-progress' : 'badge-status'}">${getProjectStatus()}</span>
                    </div>
                </header>

                <!-- CONTEXT HEADER -->
                <section class="context-header">
                    <h1>${isProofPage ? 'Proof of Build' : step.title}</h1>
                    <p class="subtext">${isProofPage ? 'Verify your milestones and submit your project artifacts.' : `Follow the prompt to build this step. Paste your artifact to unlock the next phase.`}</p>
                </section>

                <!-- WORKSPACE -->
                <main class="workspace">
                    <div class="primary-panel">
                        ${mainContent}
                    </div>
                    <aside class="secondary-panel">
                        ${!isProofPage ? buildPanel : ''}
                    </aside>
                </main>

                <!-- FOOTER -->
                ${footer}
            `;
        }

        // Initialize
        render();

    </script>
</body>

</html>